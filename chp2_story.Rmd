---
title: "Chapter 2 Drafting"
author: "Montana"
date: "2022-09-20"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "C:/Users/monta/OneDrive - Airey Family/GitHub/AFRP")
```


```{r, echo = F, warning = F, message = F }
# Setup
library(corrplot)
library(Hmisc)
library(MASS)
require(pscl) # alternatively can use package ZIM for zero-inflated 
library(lmtest)
library(dplyr)
library(tidyr)
library(tidyverse)
library(vegan)
library(RColorBrewer)
library(ggridges)
library(ecp)
library(dplyr)
library(knitr)

## Functions source -----------
source("AFRP_Master_Code/AFRP_Functions.R",local = knitr::knit_global())
sample = read.csv("MA2276_Code/Data/FISH_SAMPLE_edited.csv")

# Boat Electrofishing Data
BEF_data_unfiltered = filter_data(water = "LML", gear = "BEF",
                                  gear_code = "NAF", 
                                  species = species) %>% 
  filter(MONTH %in% c(4,5,6,7,8), YEAR >= 1998)

# Removing species ---------------
`%nin%` = Negate(`%in%`) # sets up a way to exclude if in a string
rare_threashold = 50 ## change this based on preference
rare = BEF_data_unfiltered %>% group_by(SPECIES) %>% 
  summarise(frequency = n()) %>% 
  filter(frequency < rare_threashold)
stocked = c("LLS", "RT") ## Stocked fish in little moose
remove = c(stocked, rare$SPECIES,"RWF") ## Remove SMB + RWF (targeted 2000s)
# I'm also going to remove LT and RS because I want to focus mostly on native littoral fishes 
BEF_data = BEF_data_unfiltered %>% filter(SPECIES %nin% remove)
site_hab = BEF_data %>% select(SITE, HAB_1) %>%
  rename(Site = SITE) %>%
  unique()
CPUE.w.sec = ((CPUE_wide_seconds(BEF_data) %>%
                 unite("Group", c(YEAR, SITE)) %>% 
                 column_to_rownames(., var = "Group") %>% 
                 mutate(sumrow = rowSums(.)) %>%
                 filter(sumrow>0) %>%
                 select(-sumrow)))
cpue.habs = CPUE.w.sec %>% 
  mutate(names = rownames(.)) %>% 
  separate(names, into = c("year", "Site")) %>%
  left_join(site_hab) %>%
  select(Site, HAB_1)
```


```{r, echo  = F, results = F, message= F}
# Continued data setup
c_raw = BEF_data %>% 
  mutate(LENGTH = .bincode(LENGTH, breaks = c(0,100,8000))) %>%
  unite("SPECIES", c(SPECIES, LENGTH), remove = F) %>% 
  filter(!is.na(LENGTH)) 


neighbor =read.csv("Data/BEFsites_LengthAndHabitat.csv") %>%
  filter(Water == "LML") %>%
  select(SITE, Habitat, Actual_Order) %>%
  arrange(Actual_Order) %>%
  mutate(neighbor_1 = lag(Habitat)) %>%
  mutate(neighbor_2 = lead(Habitat)) %>%
  mutate(SITE = as.numeric(SITE))


neighbor$neighbor_1[1] = neighbor$Habitat[32]
neighbor$neighbor_2[32] = neighbor$Habitat[1]

neighbor = neighbor %>% mutate(neighbor_1 = replace(neighbor_1, neighbor_1 =="S", 1), 
         neighbor_1 = replace(neighbor_1, neighbor_1 =="SW", 1),
         neighbor_1 = replace(neighbor_1, neighbor_1 =="R", 0),  
         neighbor_1 = replace(neighbor_1, neighbor_1 =="RW", 0),
         neighbor_2 = replace(neighbor_2, neighbor_2 =="S", 1), 
         neighbor_2= replace(neighbor_2, neighbor_2 =="SW", 1),
         neighbor_2 = replace(neighbor_2, neighbor_2 =="R", 0),  
         neighbor_2 = replace(neighbor_2, neighbor_2 =="RW", 0)) %>%
  mutate(sum = as.numeric(neighbor_1) + as.numeric(neighbor_2))

c = CPUE_long_seconds(c_raw) %>% 
  separate(SPECIES, into = "SPECIES", "SIZE") %>%
  mutate(CPUE_seconds = CPUE_seconds  * 60 * 60 )%>%
  group_by(SPECIES, SITE) %>%
  dplyr::summarize(mean = mean(CPUE_seconds)) %>%
  mutate(SITE = as.numeric(SITE)) %>%
  left_join(neighbor)
```

# Chapter 2 Project Outline

### Background - 

Not all species in LML show large or sustained recovery after the initiation of the bass removal. These preliminary analyses suggest that particular sites or habitats may be important to the direction of a species response within the lake.  

![Cat](C:\Users\monta\OneDrive - Airey Family\GitHub\AFRP\MA2276_Code\CC_cpue.png){width=20%}![C](C:\Users\monta\OneDrive - Airey Family\GitHub\AFRP\MA2276_Code\CS_cpue.png){width=20%}![c](C:\Users\monta\OneDrive - Airey Family\GitHub\AFRP\MA2276_Code\MM_cpue.png){width=20%}



The goal of this project is to further investigate the responses of these species and the importance of site, habitat, and size structure. 

### What role does habitat play in species distributions? 

Kruskal test to examine variation in CPUE across habitat types. 


```{r, echo = F}
for(i in unique(c$SPECIES)){
  dat = c %>% filter(SPECIES == i)
  z = kruskal.test(dat$mean ~ dat$Habitat)
  if(z$p.value < .05){print(i)}
}
```

So, it looks like CC, CS, MM, PS, SMB, ST, and WS YOY all appear to show differences in relative abundance across different habitats. Whereas only CC, CS, SMB, and ST show differences in relative abundance across different habitats as adults. 

### Which habitats are most important to each species success? 

```{r, echo = F, warning=F, message= F, results = F}
## Habitat changepoints ------------------
vec = vector()
p.val = vector()
species = colnames(CPUE.w.sec)
#species = c("CC", "CS")
change_points_list = list()
v = CPUE.w.sec %>% 
  mutate(y_s = rownames(CPUE.w.sec)) %>%
  mutate(HAB_1 = cpue.habs$HAB_1) %>%
  pivot_longer(1:length(species),
               names_to = "Species") %>%
  separate(y_s, 
           into = c("Year", "site")) %>%
  unite("ID", 
        c(site:Species), 
        sep = "_", 
        remove = F) %>%
  select(-site)%>%
  mutate(value = value * 60 * 60 )
summary_graph_data = list()
## Fixed change point using multiple sites a year as multivariate --------- 
for(i in 1:length(species)){
  list_habitats = list()
    for(h in c("R","RW","S","SW")){
      # Set up data frame
      x = v %>% filter(Species == species[i], HAB_1 == h) %>%
        mutate(value = as.numeric(value)) %>% 
        select(-Species, -HAB_1) %>%
        mutate(value = log10(value+1)) %>%
        pivot_wider(values_from = value,
                    names_from = ID) %>%
        replace(is.na(.), 0) %>%
        select(-Year) %>%
        as.matrix()
      rownames(x) = unique(v$Year)
      
    # Run changepoint analysis ---------------
    output = e.divisive(x, 
                        R = 499, 
                        alpha = 1, 
                        min.size = 2,
                        sig.lvl = .05)
    
    # Format data -------------------------
    dat = data.frame(Year = unique(v$Year), 
                     color = output$cluster)
    v_mod = left_join(v,dat)
  # Plots
  
  # Filtering out the data for this species habitat combo
  hab_species_data = v_mod %>%
    filter(Species == species[i], HAB_1 == h)
  # Create a list to put the above data into
  list_habitats[[h]] = hab_species_data
  }
  
  # Uniting the data with the habitat information in it
  cpoint_dataframe = rbind(list_habitats[[1]],list_habitats[[2]], list_habitats[[3]],list_habitats[[4]])
  
  # Creating the changepoint graphs--------------
  
  graph = cpoint_dataframe %>% ggplot(aes(x = as.numeric(Year), 
                            y = value)) + 
    geom_point(aes(color = as.character(color))) +
    facet_wrap(~HAB_1) + 
    theme(axis.text.x = element_text(angle = 90),
          legend.position = "none") + 
    xlim(1998, 2021) +
    ylab(paste(species[i],"CPUE")) +
    xlab("Year")
  
  #if(species[i] %in% c("CC","CS")){print(graph)}
  
  # Pulling together data for summary graphs
  summary_data = cpoint_dataframe %>% 
    group_by(Year, HAB_1, Species, color) %>%
    dplyr::summarize(median = median(value), mean = mean(value))
  
  cp_summary_list = list()
  blank_data = data.frame(HAB_1 = NA,
                                    Species = NA,
                                    color = NA, 
                                    min = NA)
  cp_summary_list[[1]] = blank_data
  cp_summary_list[[2]] = blank_data
  cp_summary_list[[3]] = blank_data
  cp_summary_list[[4]] = blank_data
  
  # Filling out the information in the summary list 
  
  if((2 %in% summary_data$color) == TRUE){
    for(z in 1:(max(summary_data$color)-1)){
    ## Creats a point for every changepoint that occurs
    cp_summary_list[[z]] = summary_data %>% filter(color > z) %>% 
      ungroup() %>% group_by(HAB_1, Species, color) %>% 
      dplyr::summarize(min = min(Year))
    
    }
    # Fill out any continuous data with NAs and the species info
  }else(cp_summary_list[[i]] = data.frame(HAB_1 = NA, Species = species[i], color = 1, min = NA))
 
  # Unlist the summary data to make into a dataframe 
  unlisted_summary = rbind(cp_summary_list[[1]],cp_summary_list[[2]], cp_summary_list[[3]],cp_summary_list[[4]])
  
  # Calculate the median CPUE for each changepoint section (or the whole thing)
  median_data = summary_data %>% ungroup() %>% group_by(HAB_1, Species, color) %>% 
    dplyr::summarise(median = median(median), 
              mean = mean(mean))
  
  # Add in the regressions 
  unlisted_summary = full_join(unlisted_summary, median_data)
  summary_graph_data[[i]] = unlisted_summary
 
}

```

```{r, echo = F, warning=F, message= F, error=F, results='hide'}

## Changepoint analysis summary
un_sum = rbind(summary_graph_data[[1]],
               summary_graph_data[[2]],
               summary_graph_data[[3]],
               summary_graph_data[[4]],
               summary_graph_data[[5]],
               summary_graph_data[[6]],
               summary_graph_data[[7]],
               summary_graph_data[[8]],
               summary_graph_data[[9]],
               summary_graph_data[[10]], 
               summary_graph_data[[11]]) %>%
  as.data.frame() %>%
  filter(is.na(Species) == FALSE, 
         is.na(HAB_1) == FALSE)


changepoint_data = un_sum %>% unique() %>% 
  arrange(Species, HAB_1, color) %>% 
  group_by(HAB_1, Species) %>% 
  summarise(sum_color = sum(color)) %>% 
  filter(sum_color > 1) %>% 
  mutate(type = "changepoint") 


## This appears to be working this is the data that can go into the graph. I just need to now figure out how to create a - or + for the lag column for the graph and also to put in the direction for the continuous data 
data = left_join(un_sum, changepoint_data) %>% 
  mutate(type  = replace_na(type, "continuous"))%>% 
  arrange(Species, HAB_1, color) %>%
  ungroup() %>%
  unique() %>% 
  group_by(HAB_1, Species) %>%
  mutate(lag = mean - lag(mean), 
         lag_mean = mean - lag(mean)) %>%
  mutate(lag_mean = sign(lag_mean)) %>%
  mutate(lag_mean = replace(lag_mean, lag_mean == 1, "+")) %>%
  mutate(lag_mean = replace(lag_mean, lag_mean == -1, "-"))
  
## Models for continuous data 
cat = matrix(data = NA, ncol = 4, nrow = 11)
dog = matrix(data = NA, ncol = 4, nrow = 11)
for(i in 1:4){
  
  g = data %>% 
    filter(HAB_1 == unique(data$HAB_1)[i])
   
  for(h in 1:11){
    
    Pred = "NA" 
    M4 = "NA"
    lm_data = v_mod %>% filter(Year > 2000, 
                                          HAB_1 == unique(data$HAB_1)[i],
                                          Species == unique(g$Species)[h]) %>% 
      mutate(value = round(value), 
             Year = as.numeric(Year))
    
     dat_graph.pred = lm_data %>%
        filter(Year > 2000)   %>% 
        mutate(Year = as.numeric(Year)) %>%
        mutate(Year = scale(Year)[,1]) 
      
    try(M4 <- zeroinfl(value ~ (Year) | (Year),
                         dist = 'negbin',
                         data = dat_graph.pred))
    
    
    
    try(Pred<- predict(M4,newdata = dat_graph.pred, type = "response"))
    
    
    
    
     
    cat[h, i] = mean(Pred[1:5]) < mean(Pred[length(Pred) - 5:length(Pred)]) 
    
    
    
    dog[h, i] = try( summary(M4)$coef[[2]][2,4] < .05)
    
    
  }
}    

 
rownames(cat) = unique(g$Species)
colnames(cat) = unique(data$HAB_1)
rownames(dog) = unique(g$Species)
colnames(dog) = unique(data$HAB_1)
  
regression_data  = cat %>% as.data.frame() %>% 
    rownames_to_column(var = "Species") %>%
    pivot_longer(R:SW, names_to = "HAB_1") %>% 
  mutate(value = replace(value, value == "TRUE","#00BFC4"),
         value = replace(value, value == "FALSE", "#F8766D"))

significance_data = dog %>% as.data.frame() %>%
  rownames_to_column(var = "Species") %>%
  pivot_longer(R:SW, names_to = "HAB_1") %>% 
  mutate(value = replace(value, value == "FALSE", "insig"), 
         value = replace(value, value == "TRUE", "sig")) %>%
  rename(significance= value)


l = list()

for(i in 1:4){
  
  data_regression  = data %>% 
    left_join(regression_data) %>% 
    left_join(significance_data) %>%
    filter(HAB_1 == unique(data$HAB_1)[i]) %>%
    mutate(lag = log10(abs(lag))*20)
  
  cont = data_regression %>%
    filter(type == "continuous", significance == "sig") %>%
    unique()
  
  if(i == 4){
    cont[3,1] = "SW"
    cont[3,2] = "PS"
    cont[3,3] = 1
    cont[3,11] = "#00BFC4" 
    cont[3,12] = "sig" 
    cont[3, 6] = 165.5144
  } else {cont = cont}
  
  l[[i]] = data_regression %>% ggplot() + 
    geom_text(aes(x = as.numeric(min),
                  y = Species, 
                  col = as.factor(lag_mean),
                  label = lag_mean,
                  size = lag)) + 
    theme(legend.position = "none") + 
    xlab("Year") + 
    ylab(paste(unique(data$HAB_1)[i])) + 
    geom_hline(yintercept = cont$Species, col = cont$value, lwd = log((cont$mean)+1)) + 
    xlim(1999, 2020)
    
  
  # Here I made the size of the line the mean for the post 2000 CPUE. Bigger line means more fish... 

}

do.call(gridExtra::grid.arrange, l)


```

##### Major-takeaways

Above is a summary of a changepoint analysis for the relative abundance of each species, separated by habitat. Solid lines indicate the significant results of zero-inflated regressions. The width of the line reflects the magnitude of the trend. The `+` or `-` symbols indicate a positive or negative changepoint (respectively). The size of each symbol reflects the magnitude of the difference in means between the two changepoints. 

We see that S and SW habitats demonstrate many, large positive responses in R, S, and SW. Mudminnows, common shiners, and creek chubs appear to do best in S or SW habitats. While, smallmouth bass appear to do best in rocky habitats. 


As an example - note the below graph that demonstrates difference in CPUE across sites and habitats 

```{r, echo = F, message = F, result = F}
v_mod %>% mutate(SITE = parse_number(ID)) %>%
  left_join(read.csv("Data/BEFsites_LengthAndHabitat.csv")) %>%
  filter(Water == "LML") %>%
  filter(Species %in% c("CC", "CS", "WS","MM")) %>%
  ggplot(aes(x = Actual_Order, y = value, color = HAB_1)) + 
  geom_point() +
  ylab("CPUE") + 
  xlab("Site") +
  facet_wrap(~Species)
```

Note - an additional size-based changepoint analysis was run. There are no changepoints that appear when separated by habitat. 



### Given that these more vulnerable species seem to do better in sediment habitats, does being near other sediment habitats confer some benefits? 

```{r, echo = F}
mat = matrix(NA, nrow = length(unique(c$SPECIES)), ncol = 2)

c = c %>% separate(SPECIES, into=c("species_code", "size_class"), remove = F)

for(i in 1:length(unique(c$SPECIES))){
  
  cor_dat = c %>% filter(SPECIES == unique(c$SPECIES)[i]) %>%
  ungroup() %>%
  select(mean, sum)
  res = rcorr(as.matrix(cor_dat), type = "spearman")
  mat[i,1] = res$r[2]
  mat[i,2] = res$P[2]
  
}
rownames(mat) = unique(c$SPECIES)
colnames(mat) = c("cor", "p.value")

mat %>% as.data.frame() %>% filter(p.value < .05) 


#%>% 
 # ggplot(aes(y = rownames(.),
  #           x = as.character(1), 
   #          size = cor, 
    #         color = cor)) +
  #geom_point() + 
  #theme(legend.position = "none") + 
  #ylab("") + 
  #xlab("Correlation")


```


The relative abundance of YOY for brook trout, mudminnows, common shiners, and creek chub is all positively correlated with increasing number of neighboring sediment sites. Adult common shiners also appear to be slightly positively coorelated. 

#### We know that these species do poorly in rocky sites - does having a nearby sandy site lead to higher relative abundances within a rocky patch?

No - only smelt appear t show a positve correlation between relative abundance within a rocky or rocky woody site and number of neighboring sediment or sediment woody sites. 

```{r, echo = F}
mat = matrix(NA, nrow = length(unique(c$SPECIES)), ncol = 2)


for(i in 1:length(unique(c$SPECIES))){
  
  cor_dat = c %>% filter(Habitat %in% c("R", "RW")) %>%
  filter(SPECIES == unique(c$SPECIES)[i]) %>%
  ungroup() %>%
  select(mean, sum)
  res = rcorr(as.matrix(cor_dat), type = "spearman")
  mat[i,1] = res$r[2]
  mat[i,2] = res$P[2]
  
}
rownames(mat) = unique(c$SPECIES)
colnames(mat) = c("cor", "p.value")
mat %>% as.data.frame() %>% filter(p.value < .05)
```


This may suggest that being near other sediment patches doesn't confer benefit in rocky sites but it may confer benefit to individuals within other sediment sites. There may not be that much of a spillover effect into sub-optimal habitats for these species either because of habitat preferences or because of competition/predation effects within the rocky sites. 

##### So, how is the relative abudnance of invasive bass correlated to the relative abundances of these sensitive native fish across all habitats?


Overall - the YOY of CC, CS, and MM are negatively correlated with YOY SMB but not adult SMB. Correlation != causation but perhaps there is something about sites with high relative abundances of SMB that is suboptimal for CC, CS, and MM.  

```{r, echo = F}
species_mean_cpue = c %>% 
  filter(species_code %in% c("CC", "CS", "MM","WS", "PS","SMB")) %>%
  select(SPECIES, SITE, mean) %>% 
  pivot_wider( names_from = SPECIES, values_from = mean) %>% 
  select(-SITE)
res = rcorr(as.matrix(species_mean_cpue), type = "pearson")
corrplot(res$r, diag = F, type = "upper",p.mat = res$P, insig = "blank", sig.level = .05)

```
 
Con of above matrix - could just be a result of these species having different habitat preferences at different sizes. Try controlling for this by looking at the same matrices but isolted by habitat type. 

##### How is the relative abundance of invasive bass correlated to the relative abundances of these sensitive fish within each habitat?


```{r, echo = F}
for(i in c("R", "S","SW")){
  species_mean_cpue = c %>% 
    filter(species_code %in% c("CC", "CS", "MM","WS", "PS","SMB"), 
           Habitat == i) %>%
    select(SPECIES, SITE, mean) %>% 
    pivot_wider( names_from = SPECIES, values_from = mean) %>% 
    select(-SITE)
  res = rcorr(as.matrix(species_mean_cpue), type = "pearson")
  corrplot(res$r, diag = F, type = "upper",p.mat = res$P, insig = "blank", sig.level = .05)
  title(paste(i))
}
```

Main takeaways- 

Higher densities of YOY CC are observed at SW sites that have lower relative abundances of YOY SMB.

No negative correlations between SMB and native species found at S sites. 

At R sites, CC of both size classes are positively correlated with adult SMB. 
At R sites, CS of both size classes are negatively correlated with YOY SMB. 

Overall, it appears like there is a negative relationship between CC and SMB YOY at SW sites and between CS and SMB YOY at R sites. 

